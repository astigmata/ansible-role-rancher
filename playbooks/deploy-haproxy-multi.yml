---
# =============================================================================
# Deploy Multiple HAProxy Ingress Controllers via Rancher API (v2.9+)
# =============================================================================
# This playbook deploys multiple HAProxy Ingress Controllers with different
# configurations using Rancher's catalog.cattle.io and helm.cattle.io APIs
#
# Requirements:
#   - Rancher 2.6+ server accessible and running
#   - Admin credentials for Rancher API
#
# Usage:
#   ansible-playbook playbooks/deploy-haproxy-multi.yml \
#     -e rancher_url=https://localhost:8443 \
#     -e rancher_admin_password=admin123456789
#
# Examples of custom configurations:
#   # Deploy with custom instances
#   ansible-playbook playbooks/deploy-haproxy-multi.yml \
#     -e rancher_url=https://localhost:8443 \
#     -e rancher_admin_password=admin123456789 \
#     -e '{"haproxy_instances": [{"name": "haproxy-edge", "kind": "DaemonSet"}, {"name": "haproxy-internal", "kind": "Deployment", "replicas": 3}]}'
# =============================================================================

- name: Deploy Multiple HAProxy Ingress Controllers via Rancher API v2
  hosts: localhost
  gather_facts: false

  vars:
    # Rancher API Configuration
    rancher_url: "https://192.168.56.10:8443"
    rancher_admin_user: "admin"
    rancher_admin_password: "admin123456789"
    rancher_verify_ssl: false

    # HAProxy Namespace
    haproxy_namespace: "haproxy-controller"

    # Helm Repository Configuration
    haproxy_repo_name: "haproxy"
    haproxy_repo_url: "https://haproxytech.github.io/helm-charts"
    haproxy_chart_name: "kubernetes-ingress"

    # Multiple HAProxy Instances Configuration
    # Each instance can have different settings
    haproxy_instances:
      # Instance 1: DaemonSet with ExternalTrafficPolicy=Local (Edge/Public traffic)
      - name: "haproxy-edge"
        kind: "DaemonSet"
        ingress_class: "haproxy-edge"
        service_type: "LoadBalancer"
        external_traffic_policy: "Local"
        disable_ipv6: true
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        default_backend:
          enabled: true
          replicas: 1

      # Instance 2: Deployment without ExternalTrafficPolicy=Local (Internal traffic)
      - name: "haproxy-internal"
        kind: "Deployment"
        replicas: 2
        ingress_class: "haproxy-internal"
        service_type: "LoadBalancer"
        external_traffic_policy: "Cluster"  # Default Kubernetes behavior
        disable_ipv6: true
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "250m"
            memory: "256Mi"
        default_backend:
          enabled: true
          replicas: 1

  tasks:
    # =========================================================================
    # STEP 1: Authenticate with Rancher API
    # =========================================================================
    - name: Login to Rancher API
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3-public/localProviders/local?action=login"
        method: POST
        body_format: json
        body:
          username: "{{ rancher_admin_user }}"
          password: "{{ rancher_admin_password }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: 201
      register: rancher_login

    - name: Extract Rancher API token
      ansible.builtin.set_fact:
        rancher_token: "{{ rancher_login.json.token }}"

    - name: Display authentication status
      ansible.builtin.debug:
        msg: "✓ Successfully authenticated to Rancher API"

    # =========================================================================
    # STEP 2: Add HAProxy Helm Repository (ClusterRepo)
    # =========================================================================
    - name: Check if HAProxy ClusterRepo already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos/{{ haproxy_repo_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: repo_check
      failed_when: false

    - name: Create HAProxy ClusterRepo
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "catalog.cattle.io.clusterrepo"
          metadata:
            name: "{{ haproxy_repo_name }}"
          spec:
            url: "{{ haproxy_repo_url }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: repo_check.status == 404
      register: repo_create

    - name: Wait for ClusterRepo to be ready
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos/{{ haproxy_repo_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: repo_status
      until: >
        repo_status.json.status is defined and
        repo_status.json.status.conditions is defined and
        (repo_status.json.status.conditions | selectattr('type', 'equalto', 'Downloaded') | map(attribute='status') | list | first | default('False')) == 'True'
      retries: 30
      delay: 5
      when: repo_check.status == 404

    - name: Display repository status
      ansible.builtin.debug:
        msg: "✓ HAProxy Helm repository ready"

    # =========================================================================
    # STEP 3: Create Namespace
    # =========================================================================
    - name: Create namespace for HAProxy Ingress
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/namespaces"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "namespace"
          metadata:
            name: "{{ haproxy_namespace }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201, 409]
      register: namespace_result
      failed_when: false

    - name: Display namespace status
      ansible.builtin.debug:
        msg: "✓ Namespace '{{ haproxy_namespace }}' ready"

    # =========================================================================
    # STEP 4: Deploy Multiple HAProxy Ingress Instances
    # =========================================================================
    - name: Deploy HAProxy Ingress instances
      include_tasks: deploy-haproxy-instance.yml
      loop: "{{ haproxy_instances }}"
      loop_control:
        loop_var: instance

    # =========================================================================
    # STEP 5: Display Deployment Summary
    # =========================================================================
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "======================================================="
          - "Multiple HAProxy Ingress Controllers Deployment Summary"
          - "======================================================="
          - "Namespace: {{ haproxy_namespace }}"
          - "Instances deployed: {{ haproxy_instances | length }}"
          - "======================================================="
          - "Verify deployments with:"
          - "  kubectl get all -n {{ haproxy_namespace }}"
          - "  kubectl get ingress -A"
          - "======================================================="
