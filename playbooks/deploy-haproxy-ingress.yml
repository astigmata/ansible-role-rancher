---
# =============================================================================
# Deploy HAProxy Ingress Controller via Rancher API
# =============================================================================
# This playbook deploys HAProxy Ingress Controller using Rancher's Helm/Apps API
# exactly as if installing through the Rancher web UI
#
# Requirements:
#   - Rancher server accessible and running
#   - Admin credentials for Rancher API
#
# Usage:
#   ansible-playbook playbooks/deploy-haproxy-ingress.yml \
#     -e rancher_url=https://rancher.example.com \
#     -e rancher_admin_password=YourPassword
# =============================================================================

- name: Deploy HAProxy Ingress Controller via Rancher API
  hosts: localhost
  gather_facts: false

  vars:
    # Rancher API Configuration
    rancher_url: "{{ rancher_url | default('https://localhost:8443') }}"
    rancher_admin_user: "admin"
    rancher_admin_password: "{{ rancher_admin_password }}"
    rancher_verify_ssl: false

    # HAProxy Ingress Configuration
    haproxy_namespace: "haproxy-controller"
    haproxy_app_name: "haproxy-ingress"

    # Helm Chart Configuration
    haproxy_catalog_name: "haproxy"
    haproxy_catalog_url: "https://haproxytech.github.io/helm-charts"
    haproxy_chart_name: "kubernetes-ingress"

    # HAProxy Values
    haproxy_controller_kind: "DaemonSet"
    haproxy_external_traffic_policy: "Local"
    haproxy_ipv6_enabled: false

  tasks:
    # =========================================================================
    # STEP 1: Authenticate with Rancher API
    # =========================================================================
    - name: Login to Rancher API
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3-public/localProviders/local?action=login"
        method: POST
        body_format: json
        body:
          username: "{{ rancher_admin_user }}"
          password: "{{ rancher_admin_password }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: 201
      register: rancher_login

    - name: Extract Rancher API token
      ansible.builtin.set_fact:
        rancher_token: "{{ rancher_login.json.token }}"

    - name: Display authentication status
      ansible.builtin.debug:
        msg: "✓ Successfully authenticated to Rancher API"

    # =========================================================================
    # STEP 2: Get Local Cluster Information
    # =========================================================================
    - name: Get list of clusters
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/clusters"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: rancher_clusters

    - name: Find local cluster
      ansible.builtin.set_fact:
        local_cluster: "{{ rancher_clusters.json.data | selectattr('name', 'equalto', 'local') | first }}"

    - name: Get default project in local cluster
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/projects?clusterId={{ local_cluster.id }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: cluster_projects

    - name: Find Default project
      ansible.builtin.set_fact:
        default_project: "{{ cluster_projects.json.data | selectattr('name', 'equalto', 'Default') | first }}"

    - name: Display cluster information
      ansible.builtin.debug:
        msg:
          - "✓ Cluster ID: {{ local_cluster.id }}"
          - "✓ Project ID: {{ default_project.id }}"

    # =========================================================================
    # STEP 3: Add HAProxy Helm Catalog (Repository)
    # =========================================================================
    - name: Check if HAProxy catalog already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/catalogs"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: existing_catalogs

    - name: Check if catalog exists
      ansible.builtin.set_fact:
        catalog_exists: "{{ existing_catalogs.json.data | selectattr('name', 'equalto', haproxy_catalog_name) | list | length > 0 }}"

    - name: Add HAProxy Helm catalog
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/catalogs"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "catalog"
          name: "{{ haproxy_catalog_name }}"
          branch: "main"
          kind: "helm"
          url: "{{ haproxy_catalog_url }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201, 409]
      register: catalog_result
      when: not catalog_exists

    - name: Wait for catalog to be active
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/catalogs/{{ haproxy_catalog_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: catalog_status
      until: catalog_status.json.state == "active"
      retries: 30
      delay: 5
      when: not catalog_exists

    - name: Display catalog status
      ansible.builtin.debug:
        msg: "✓ HAProxy Helm catalog added and active"

    # =========================================================================
    # STEP 4: Create Namespace
    # =========================================================================
    - name: Create namespace for HAProxy Ingress
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/cluster/{{ local_cluster.id }}/namespaces"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "namespace"
          name: "{{ haproxy_namespace }}"
          projectId: "{{ default_project.id }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201, 409, 422]
      register: namespace_result

    - name: Display namespace status
      ansible.builtin.debug:
        msg: "✓ Namespace '{{ haproxy_namespace }}' ready"

    # =========================================================================
    # STEP 5: Deploy HAProxy Ingress via Rancher Apps API
    # =========================================================================
    - name: Get catalog template information
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/catalogs/{{ haproxy_catalog_name }}/templates/{{ haproxy_chart_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: template_info
      retries: 10
      delay: 5
      until: template_info.status == 200

    - name: Get latest chart version
      ansible.builtin.set_fact:
        chart_version: "{{ template_info.json.versions[0].version }}"

    - name: Prepare Helm values for HAProxy Ingress
      ansible.builtin.set_fact:
        haproxy_values:
          controller:
            kind: "{{ haproxy_controller_kind }}"
            service:
              type: "LoadBalancer"
              externalTrafficPolicy: "{{ haproxy_external_traffic_policy }}"
            enableIPv6: "{{ haproxy_ipv6_enabled }}"
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "500m"
                memory: "512Mi"
            logging:
              level: "info"
          defaultBackend:
            enabled: true
            replicaCount: 1

    - name: Deploy HAProxy Ingress via Rancher Apps API
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/projects/{{ default_project.id }}/apps"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "app"
          name: "{{ haproxy_app_name }}"
          targetNamespace: "{{ haproxy_namespace }}"
          projectId: "{{ default_project.id }}"
          externalId: "catalog://?catalog={{ haproxy_catalog_name }}&template={{ haproxy_chart_name }}&version={{ chart_version }}"
          answers: {}
          valuesYaml: "{{ haproxy_values | to_nice_yaml }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201, 409, 422]
      register: app_deployment

    - name: Display deployment status
      ansible.builtin.debug:
        msg: "✓ HAProxy Ingress deployment initiated"

    # =========================================================================
    # STEP 6: Wait for Deployment to Complete
    # =========================================================================
    - name: Wait for app to be deployed
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/projects/{{ default_project.id }}/apps/{{ haproxy_namespace }}:{{ haproxy_app_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: app_status
      until: >
        app_status.json.state is defined and
        app_status.json.state == "deployed"
      retries: 60
      delay: 10
      failed_when: false

    # =========================================================================
    # STEP 7: Get Deployment Information
    # =========================================================================
    - name: Get HAProxy workloads information
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3/projects/{{ default_project.id }}/workloads?namespaceId={{ haproxy_namespace }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
      register: workloads_info

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "======================================================="
          - "HAProxy Ingress Controller Deployment Summary"
          - "======================================================="
          - "Cluster: local ({{ local_cluster.id }})"
          - "Project: Default ({{ default_project.id }})"
          - "Namespace: {{ haproxy_namespace }}"
          - "App Name: {{ haproxy_app_name }}"
          - "Chart: {{ haproxy_catalog_name }}/{{ haproxy_chart_name }}"
          - "Version: {{ chart_version }}"
          - "---"
          - "Configuration:"
          - "  - Mode: {{ haproxy_controller_kind }}"
          - "  - ExternalTrafficPolicy: {{ haproxy_external_traffic_policy }}"
          - "  - IPv6: {{ 'Disabled' if not haproxy_ipv6_enabled else 'Enabled' }}"
          - "---"
          - "Status: {{ app_status.json.state | default('deploying') }}"
          - "Workloads: {{ workloads_info.json.data | length }}"
          - "======================================================="
          - ""
          - "Access via Rancher UI:"
          - "{{ rancher_url }}/p/{{ default_project.id }}/apps/{{ haproxy_namespace }}:{{ haproxy_app_name }}"
          - "======================================================="
