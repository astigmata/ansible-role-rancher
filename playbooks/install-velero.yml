---
# =============================================================================
# Install Velero on Local Cluster via Rancher API
# =============================================================================
# This playbook installs Velero backup/restore solution on the local Rancher
# cluster with MinIO as S3-compatible storage backend
#
# Requirements:
#   - Rancher 2.6+ server accessible and running
#   - Admin credentials for Rancher API
#   - Local cluster available
#
# Usage:
#   ansible-playbook playbooks/install-velero.yml
#
# What gets installed:
#   1. MinIO (S3-compatible object storage)
#   2. Velero (backup/restore tool)
#   3. Restic integration (for PV backups)
# =============================================================================

- name: Install Velero on Local Cluster via Rancher API
  hosts: localhost
  gather_facts: false

  vars:
    # Rancher API Configuration
    rancher_url: "https://192.168.56.10:8443"
    rancher_admin_user: "admin"
    rancher_admin_password: "admin123456789"
    rancher_verify_ssl: false

    # Cluster Configuration
    cluster_name: "local"  # Local cluster (Rancher's own cluster)

    # MinIO Configuration
    minio_namespace: "velero"
    minio_release_name: "minio"
    minio_access_key: "velero"
    minio_secret_key: "velero123456"
    minio_bucket: "velero"
    minio_storage_size: "10Gi"

    # Velero Configuration
    velero_namespace: "velero"
    velero_release_name: "velero"
    velero_backup_location: "default"

    # Helm Repositories
    minio_repo_name: "minio"
    minio_repo_url: "https://charts.min.io"
    velero_repo_name: "vmware-tanzu"
    velero_repo_url: "https://vmware-tanzu.github.io/helm-charts"

  tasks:
    # =========================================================================
    # STEP 1: Authenticate with Rancher API
    # =========================================================================
    - name: Login to Rancher API
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v3-public/localProviders/local?action=login"
        method: POST
        body_format: json
        body:
          username: "{{ rancher_admin_user }}"
          password: "{{ rancher_admin_password }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: 201
      register: rancher_login

    - name: Extract Rancher API token
      ansible.builtin.set_fact:
        rancher_token: "{{ rancher_login.json.token }}"

    - name: Display authentication status
      ansible.builtin.debug:
        msg: "✓ Successfully authenticated to Rancher API"

    # =========================================================================
    # STEP 2: Create Namespace for Velero
    # =========================================================================
    - name: Create namespace for Velero
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/namespaces"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "namespace"
          metadata:
            name: "{{ velero_namespace }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201, 409]
      register: namespace_result
      failed_when: false

    - name: Display namespace status
      ansible.builtin.debug:
        msg: "✓ Namespace '{{ velero_namespace }}' ready"

    # =========================================================================
    # STEP 3: Add Helm Repositories
    # =========================================================================
    - name: Check if MinIO ClusterRepo already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos/{{ minio_repo_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: minio_repo_check
      failed_when: false

    - name: Create MinIO ClusterRepo
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "catalog.cattle.io.clusterrepo"
          metadata:
            name: "{{ minio_repo_name }}"
          spec:
            url: "{{ minio_repo_url }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: minio_repo_check.status == 404

    - name: Check if Velero ClusterRepo already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos/{{ velero_repo_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: velero_repo_check
      failed_when: false

    - name: Create Velero ClusterRepo
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/catalog.cattle.io.clusterrepos"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "catalog.cattle.io.clusterrepo"
          metadata:
            name: "{{ velero_repo_name }}"
          spec:
            url: "{{ velero_repo_url }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: velero_repo_check.status == 404

    - name: Wait for repositories to be ready
      ansible.builtin.pause:
        seconds: 10

    # =========================================================================
    # STEP 4: Deploy MinIO
    # =========================================================================
    - name: Build MinIO Helm values
      ansible.builtin.set_fact:
        minio_values:
          mode: standalone
          replicas: 1
          persistence:
            enabled: false  # Disabled for minimal setup (no StorageClass available)
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          rootUser: "{{ minio_access_key }}"
          rootPassword: "{{ minio_secret_key }}"
          buckets:
            - name: "{{ minio_bucket }}"
              policy: "none"
              purge: false
          service:
            type: ClusterIP
          consoleService:
            type: ClusterIP

    - name: Convert MinIO values to YAML
      ansible.builtin.set_fact:
        minio_values_yaml: "{{ minio_values | to_nice_yaml }}"

    - name: Display MinIO configuration
      ansible.builtin.debug:
        msg:
          - "Deploying MinIO for Velero storage backend"
          - "  - Namespace: {{ minio_namespace }}"
          - "  - Bucket: {{ minio_bucket }}"
          - "  - Storage: {{ minio_storage_size }}"

    - name: Check if MinIO HelmChart already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/helm.cattle.io.helmcharts/{{ velero_namespace }}/{{ minio_release_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: minio_chart_check
      failed_when: false

    - name: Deploy MinIO via HelmChart CRD
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/helm.cattle.io.helmcharts"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "helm.cattle.io.helmchart"
          metadata:
            namespace: "{{ velero_namespace }}"
            name: "{{ minio_release_name }}"
          spec:
            repo: "{{ minio_repo_url }}"
            chart: "minio"
            targetNamespace: "{{ velero_namespace }}"
            valuesContent: "{{ minio_values_yaml }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: minio_chart_check.status == 404
      register: minio_deploy

    - name: Display MinIO deployment status
      ansible.builtin.debug:
        msg: "✓ MinIO deployment initiated"

    - name: Wait for MinIO to be ready
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for MinIO to start..."

    # =========================================================================
    # STEP 5: Create Velero Credentials Secret
    # =========================================================================
    - name: Build credentials file content
      ansible.builtin.set_fact:
        credentials_content: |
          [default]
          aws_access_key_id={{ minio_access_key }}
          aws_secret_access_key={{ minio_secret_key }}

    - name: Encode credentials in base64
      ansible.builtin.set_fact:
        credentials_b64: "{{ credentials_content | b64encode }}"

    - name: Check if Velero credentials secret exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/secrets/{{ velero_namespace }}/velero-credentials"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: secret_check
      failed_when: false

    - name: Create Velero credentials secret
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/secrets"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "secret"
          metadata:
            namespace: "{{ velero_namespace }}"
            name: "velero-credentials"
          data:
            cloud: "{{ credentials_b64 }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: secret_check.status == 404

    - name: Display secret creation status
      ansible.builtin.debug:
        msg: "✓ Velero credentials secret created"

    # =========================================================================
    # STEP 6: Deploy Velero
    # =========================================================================
    - name: Build Velero Helm values
      ansible.builtin.set_fact:
        velero_values:
          configuration:
            backupStorageLocation:
              - name: "{{ velero_backup_location }}"
                bucket: "{{ minio_bucket }}"
                prefix: velero
                provider: aws
                default: true
                accessMode: ReadWrite
                config:
                  region: minio
                  s3ForcePathStyle: "true"
                  s3Url: "http://{{ minio_release_name }}.{{ minio_namespace }}.svc:9000"
                  publicUrl: "http://{{ minio_release_name }}.{{ minio_namespace }}.svc:9000"
            volumeSnapshotLocation:
              - name: default
                provider: aws
                config: {}
          credentials:
            existingSecret: "velero-credentials"
          deployNodeAgent: true
          nodeAgent:
            podVolumePath: /var/lib/kubelet/pods
            privileged: false
            resources:
              requests:
                cpu: "100m"
                memory: "128Mi"
              limits:
                cpu: "200m"
                memory: "256Mi"
          initContainers:
            - name: velero-plugin-for-aws
              image: velero/velero-plugin-for-aws:v1.9.0
              volumeMounts:
                - mountPath: /target
                  name: plugins
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          metrics:
            enabled: true
            serviceMonitor:
              enabled: false

    - name: Convert Velero values to YAML
      ansible.builtin.set_fact:
        velero_values_yaml: "{{ velero_values | to_nice_yaml }}"

    - name: Display Velero configuration
      ansible.builtin.debug:
        msg:
          - "Deploying Velero backup solution"
          - "  - Namespace: {{ velero_namespace }}"
          - "  - Storage Backend: MinIO (S3-compatible)"
          - "  - Bucket: {{ minio_bucket }}"
          - "  - Node Agent: Enabled (for PV backups)"

    - name: Check if Velero HelmChart already exists
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/helm.cattle.io.helmcharts/{{ velero_namespace }}/{{ velero_release_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ rancher_token }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [200, 404]
      register: velero_chart_check
      failed_when: false

    - name: Deploy Velero via HelmChart CRD
      ansible.builtin.uri:
        url: "{{ rancher_url }}/v1/helm.cattle.io.helmcharts"
        method: POST
        headers:
          Authorization: "Bearer {{ rancher_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "helm.cattle.io.helmchart"
          metadata:
            namespace: "{{ velero_namespace }}"
            name: "{{ velero_release_name }}"
          spec:
            repo: "{{ velero_repo_url }}"
            chart: "velero"
            targetNamespace: "{{ velero_namespace }}"
            valuesContent: "{{ velero_values_yaml }}"
        validate_certs: "{{ rancher_verify_ssl }}"
        status_code: [201]
      when: velero_chart_check.status == 404
      register: velero_deploy

    - name: Display Velero deployment status
      ansible.builtin.debug:
        msg: "✓ Velero deployment initiated"

    # =========================================================================
    # STEP 7: Display Deployment Summary
    # =========================================================================
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "======================================================="
          - "Velero Installation Summary"
          - "======================================================="
          - "Namespace: {{ velero_namespace }}"
          - ""
          - "MinIO Storage Backend:"
          - "  - Service: {{ minio_release_name }}.{{ minio_namespace }}.svc:9000"
          - "  - Bucket: {{ minio_bucket }}"
          - "  - Storage Size: {{ minio_storage_size }}"
          - "  - Access Key: {{ minio_access_key }}"
          - "  - Secret Key: {{ minio_secret_key }}"
          - ""
          - "Velero Configuration:"
          - "  - Provider: AWS (S3-compatible)"
          - "  - Node Agent: Enabled (restic for PV backups)"
          - "  - Backup Location: {{ velero_backup_location }}"
          - ""
          - "======================================================="
          - "Next Steps:"
          - "======================================================="
          - ""
          - "1. Wait for Velero to be ready (2-3 minutes):"
          - "   kubectl get pods -n {{ velero_namespace }}"
          - ""
          - "2. Verify backup location:"
          - "   velero backup-location get"
          - ""
          - "3. Create your first backup:"
          - "   velero backup create my-backup --include-namespaces default"
          - ""
          - "4. List backups:"
          - "   velero backup get"
          - ""
          - "5. Access MinIO Console (optional):"
          - "   kubectl port-forward -n {{ velero_namespace }} svc/{{ minio_release_name }}-console 9001:9001"
          - "   Open: http://localhost:9001"
          - "   Login: {{ minio_access_key }} / {{ minio_secret_key }}"
          - ""
          - "======================================================="
          - "Documentation:"
          - "======================================================="
          - "  - Velero Docs: https://velero.io/docs/"
          - "  - Backup Guide: https://velero.io/docs/main/backup-reference/"
          - "  - Restore Guide: https://velero.io/docs/main/restore-reference/"
          - "======================================================="

    - name: Save Velero configuration to file
      ansible.builtin.copy:
        content: |
          # Velero Configuration
          # Installed: {{ lookup('pipe', 'date -Iseconds') }}

          ## MinIO Storage Backend
          Service: {{ minio_release_name }}.{{ minio_namespace }}.svc:9000
          Bucket: {{ minio_bucket }}
          Access Key: {{ minio_access_key }}
          Secret Key: {{ minio_secret_key }}

          ## Velero CLI Commands

          # Check status
          kubectl get pods -n {{ velero_namespace }}
          velero version

          # Create a backup
          velero backup create my-backup --include-namespaces default
          velero backup create all-namespaces --exclude-namespaces kube-system,kube-public

          # List backups
          velero backup get
          velero backup describe my-backup

          # Restore from backup
          velero restore create --from-backup my-backup
          velero restore get

          # Schedule automatic backups
          velero schedule create daily-backup --schedule="0 2 * * *" --include-namespaces default
          velero schedule get

          # Backup with PV snapshots (using restic/node-agent)
          velero backup create pv-backup --default-volumes-to-fs-backup

          ## MinIO Console Access
          kubectl port-forward -n {{ velero_namespace }} svc/{{ minio_release_name }}-console 9001:9001
          # Then open: http://localhost:9001
          # Login: {{ minio_access_key }} / {{ minio_secret_key }}

          ## Troubleshooting
          kubectl logs -n {{ velero_namespace }} deployment/{{ velero_release_name }} -f
          kubectl get backupstoragelocation -n {{ velero_namespace }}
        dest: "{{ playbook_dir }}/../velero-config.txt"
      delegate_to: localhost

    - name: Display file saved message
      ansible.builtin.debug:
        msg: "✓ Configuration saved to: velero-config.txt"
