---
# ---------------------------------------------------------
# SELF-SIGNED CERTIFICATE GENERATION (using community.crypto)
# ---------------------------------------------------------
- name: Generate private key for self-signed certificate
  community.crypto.openssl_privatekey:
    path: "{{ rancher_ssl_cert_dir }}/key.pem"
    size: 2048
    type: RSA
    mode: '0600'
    owner: root
    group: root
    state: present

- name: Generate certificate signing request (CSR)
  community.crypto.openssl_csr:
    path: "{{ rancher_ssl_cert_dir }}/csr.pem"
    privatekey_path: "{{ rancher_ssl_cert_dir }}/key.pem"
    country_name: "{{ rancher_ssl_selfsigned_country }}"
    state_or_province_name: "{{ rancher_ssl_selfsigned_state }}"
    locality_name: "{{ rancher_ssl_selfsigned_locality }}"
    organization_name: "{{ rancher_ssl_selfsigned_organization }}"
    common_name: "{{ rancher_ssl_selfsigned_common_name }}"
    key_usage:
      - keyEncipherment
      - dataEncipherment
    extended_key_usage:
      - serverAuth
    subject_alt_name:
      - "IP:{{ rancher_ssl_selfsigned_common_name }}"
      - "DNS:{{ rancher_ssl_selfsigned_common_name }}"
      - "DNS:localhost"
    mode: '0644'
    owner: root
    group: root

- name: Generate self-signed certificate
  community.crypto.x509_certificate:
    path: "{{ rancher_ssl_cert_dir }}/cert.pem"
    privatekey_path: "{{ rancher_ssl_cert_dir }}/key.pem"
    csr_path: "{{ rancher_ssl_cert_dir }}/csr.pem"
    provider: selfsigned
    selfsigned_not_after: "+{{ rancher_ssl_selfsigned_days }}d"
    mode: '0644'
    owner: root
    group: root
    state: present

- name: Create combined certificate file (cert + key)
  ansible.builtin.assemble:
    src: "{{ rancher_ssl_cert_dir }}"
    dest: "{{ rancher_ssl_cert_dir }}/tls.pem"
    regexp: "(cert|key)\\.pem$"
    mode: '0600'
    owner: root
    group: root
  when: false  # Disabled: using individual files instead

- name: Combine certificate and key (alternative method)
  ansible.builtin.copy:
    content: |
      {{ lookup('file', rancher_ssl_cert_dir + '/cert.pem') }}
      {{ lookup('file', rancher_ssl_cert_dir + '/key.pem') }}
    dest: "{{ rancher_ssl_cert_dir }}/tls.pem"
    mode: '0600'
    owner: root
    group: root
  when: false  # Disabled: only needed if Rancher requires combined file

- name: Display self-signed certificate warning
  ansible.builtin.debug:
    msg:
      - "WARNING: Using self-signed certificate"
      - "Your browser will show a security warning"
      - "For production, use 'provided' or 'letsencrypt' mode"
      - "Certificate CN: {{ rancher_ssl_selfsigned_common_name }}"
