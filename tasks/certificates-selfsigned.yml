---
# ---------------------------------------------------------
# SELF-SIGNED CERTIFICATE GENERATION (using community.crypto)
# ---------------------------------------------------------
- name: Install Python cryptography library (required for community.crypto)
  ansible.builtin.package:
    name: python3-cryptography
    state: present

- name: Generate private key for self-signed certificate
  community.crypto.openssl_privatekey:
    path: "{{ rancher_ssl_cert_dir }}/key.pem"
    size: 2048
    type: RSA
    mode: '0600'
    owner: root
    group: root
    state: present

- name: Generate certificate signing request (CSR)
  community.crypto.openssl_csr:
    path: "{{ rancher_ssl_cert_dir }}/csr.pem"
    privatekey_path: "{{ rancher_ssl_cert_dir }}/key.pem"
    country_name: "{{ rancher_ssl_selfsigned_country }}"
    state_or_province_name: "{{ rancher_ssl_selfsigned_state }}"
    locality_name: "{{ rancher_ssl_selfsigned_locality }}"
    organization_name: "{{ rancher_ssl_selfsigned_organization }}"
    common_name: "{{ rancher_ssl_selfsigned_common_name }}"
    key_usage:
      - keyEncipherment
      - dataEncipherment
    extended_key_usage:
      - serverAuth
    subject_alt_name:
      - "IP:{{ rancher_ssl_selfsigned_common_name }}"
      - "DNS:{{ rancher_ssl_selfsigned_common_name }}"
      - "DNS:localhost"
    mode: '0644'
    owner: root
    group: root

- name: Generate self-signed certificate
  community.crypto.x509_certificate:
    path: "{{ rancher_ssl_cert_dir }}/cert.pem"
    privatekey_path: "{{ rancher_ssl_cert_dir }}/key.pem"
    csr_path: "{{ rancher_ssl_cert_dir }}/csr.pem"
    provider: selfsigned
    selfsigned_not_after: "+{{ rancher_ssl_selfsigned_days }}d"
    mode: '0644'
    owner: root
    group: root
    state: present

- name: Verify generated certificate
  community.crypto.x509_certificate_info:
    path: "{{ rancher_ssl_cert_dir }}/cert.pem"
  register: selfsigned_cert_info

- name: Verify generated private key
  community.crypto.openssl_privatekey_info:
    path: "{{ rancher_ssl_cert_dir }}/key.pem"
  register: selfsigned_key_info

- name: Ensure certificate matches generated key
  ansible.builtin.assert:
    that:
      - selfsigned_cert_info.public_key_fingerprints.sha256 == selfsigned_key_info.public_key_fingerprints.sha256
    fail_msg: "Generated certificate and key do not match!"
    success_msg: "Self-signed certificate successfully generated and validated"

- name: Display self-signed certificate information
  ansible.builtin.debug:
    msg:
      - "======================================================="
      - "WARNING: Using self-signed certificate"
      - "Your browser will show a security warning"
      - "For production, use 'provided' or 'letsencrypt' mode"
      - "======================================================="
      - "Certificate Details:"
      - "  Subject: {{ selfsigned_cert_info.subject | dict2items | map(attribute='value') | join(', ') }}"
      - "  Issuer: {{ selfsigned_cert_info.issuer | dict2items | map(attribute='value') | join(', ') }}"
      - "  Valid from: {{ selfsigned_cert_info.not_before }}"
      - "  Valid until: {{ selfsigned_cert_info.not_after }}"
      - "  Serial: {{ selfsigned_cert_info.serial_number }}"
      - "  Signature algorithm: {{ selfsigned_cert_info.signature_algorithm }}"
      - "  Public key: {{ selfsigned_key_info.type }} {{ selfsigned_key_info.public_data.size }} bits"
      - "======================================================="
