---
# ---------------------------------------------------------
# RANCHER DEPLOYMENT
# ---------------------------------------------------------
- name: Create Rancher persistent volume
  community.docker.docker_volume:
    name: "{{ rancher_data_volume }}"
    state: present

- name: Copy fixed Rancher entrypoint script
  ansible.builtin.copy:
    src: rancher-entrypoint-fixed.sh
    dest: /tmp/rancher-entrypoint-fixed.sh
    mode: '0755'
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Start Rancher container
  community.docker.docker_container:
    name: "{{ rancher_container_name }}"
    image: "rancher/rancher:{{ rancher_version }}"
    state: started
    restart_policy: unless-stopped
    privileged: true
    entrypoint: /tmp/rancher-entrypoint-fixed.sh
    command: "{{ (rancher_ssl_mode == 'selfsigned') | ternary(['--no-cacerts'], omit) }}"
    ports:
      - "{{ rancher_http_port }}:80"
      - "{{ rancher_port }}:443"
    volumes:
      - "{{ rancher_data_volume }}:/var/lib/rancher"
      - "{{ rancher_ssl_cert_dir }}/cert.pem:/etc/rancher/ssl/cert.pem:ro"
      - "{{ rancher_ssl_cert_dir }}/key.pem:/etc/rancher/ssl/key.pem:ro"
      - "/tmp/rancher-entrypoint-fixed.sh:/tmp/rancher-entrypoint-fixed.sh:ro"
    env:
      CATTLE_BOOTSTRAP_PASSWORD: "{{ rancher_bootstrap_password }}"
    comparisons:
      env: strict
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Wait for Rancher API availability
  ansible.builtin.uri:
    url: "https://localhost:{{ rancher_port }}/ping"
    validate_certs: false
    status_code: 200
    follow_redirects: none
  register: result
  until: result.status == 200
  retries: "{{ rancher_api_wait_retries }}"
  delay: "{{ rancher_api_wait_delay }}"
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Verify API stability (check multiple times to avoid K3s restarts)
  ansible.builtin.uri:
    url: "https://localhost:{{ rancher_port }}/ping"
    validate_certs: false
    status_code: 200
    follow_redirects: none
  register: stability_check
  failed_when: false
  loop: "{{ range(1, 4) | list }}"
  delay: 5
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Ensure API remained stable
  ansible.builtin.assert:
    that: stability_check.results | selectattr('status', 'equalto', 200) | list | length == 3
    fail_msg: "API unstable - K3s may still be initializing or restarting"
    success_msg: "API confirmed stable across multiple checks"
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Wait for Rancher health check to be ready
  ansible.builtin.uri:
    url: "https://localhost:{{ rancher_port }}/healthz"
    validate_certs: false
    status_code: 200
    return_content: true
  register: healthz_result
  until: healthz_result.status == 200 and healthz_result.content == 'ok'
  retries: "{{ rancher_full_init_retries | default(60) }}"
  delay: "{{ rancher_full_init_delay | default(10) }}"
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Wait for Rancher API to accept requests (auth providers)
  ansible.builtin.uri:
    url: "https://localhost:{{ rancher_port }}/v3-public/authProviders"
    validate_certs: false
    status_code: 200
    follow_redirects: none
  register: api_ready
  until: api_ready.status == 200
  retries: "{{ rancher_full_init_retries | default(60) }}"
  delay: "{{ rancher_full_init_delay | default(10) }}"
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Wait for local cluster to be created
  ansible.builtin.uri:
    url: "https://localhost:{{ rancher_port }}/v3/clusters/local"
    validate_certs: false
    status_code: [200, 401]
    follow_redirects: none
  register: cluster_check
  until: cluster_check.status in [200, 401]
  retries: "{{ rancher_full_init_retries | default(60) }}"
  delay: "{{ rancher_full_init_delay | default(10) }}"
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Verify K3s API Aggregation is ready
  ansible.builtin.shell: |
    set -o pipefail
    docker exec {{ rancher_container_name }} kubectl get apiservices \
      -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.status.conditions[?(@.type=="Available")].status}{"\n"}{end}' 2>/dev/null | \
    awk '{if ($2 != "True") {print $1 " not available (status: " $2 ")"; exit 1}}'
  args:
    executable: /bin/bash
  register: apiservices_check
  until: apiservices_check.rc == 0
  retries: "{{ rancher_full_init_retries | default(60) }}"
  delay: "{{ rancher_full_init_delay | default(10) }}"
  changed_when: false
  failed_when: false
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Display API Aggregation status
  ansible.builtin.debug:
    msg: >-
      {{
        'All API services are available and ready'
        if apiservices_check.rc == 0
        else 'Warning: Some API services may still be initializing - ' + (apiservices_check.stdout | default('unknown status'))
      }}
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Deployment complete
  ansible.builtin.debug:
    msg:
      - "======================================================="
      - "Rancher Server is fully initialized and ready!"
      - "Access URL: https://{{ rancher_public_ip | default(ansible_default_ipv4.address) }}:{{ rancher_port }}"
      - "{% if rancher_port != 443 %}INFO: Using non-standard HTTPS port {{ rancher_port }} (standard is 443){% endif %}"
      - "{% if rancher_http_port != 80 %}INFO: Using non-standard HTTP port {{ rancher_http_port }} (standard is 80){% endif %}"
      - "Login credentials:"
      - "  Username: admin"
      - "  Password: {{ rancher_bootstrap_password }}"
      - "======================================================="
  when: not (rancher_skip_container_deploy | default(false) | bool)

- name: Test mode - Rancher container deployment skipped
  ansible.builtin.debug:
    msg:
      - "======================================================="
      - "TEST MODE: Rancher container deployment has been skipped"
      - "All prerequisites have been validated:"
      - "  - Hardware requirements checked"
      - "  - Docker installed and running"
      - "  - Rancher data volume created"
      - "Ready for Rancher deployment in production!"
      - "======================================================="
  when: rancher_skip_container_deploy | default(false) | bool
